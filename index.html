<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Spark - Social Media Exchange</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for social media icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background for a modern feel */
            color: #e2e8f0;
        }
        .gradient-bg {
            background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .dashboard-card {
            background-color: #2d3748;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .nav-link.active {
            background-color: #4a5568;
        }
        /* Custom scrollbar for better UI */
        .scrollbar-custom::-webkit-scrollbar {
            width: 8px;
        }
        .scrollbar-custom::-webkit-scrollbar-thumb {
            background-color: #718096;
            border-radius: 4px;
        }
        .scrollbar-custom::-webkit-scrollbar-track {
            background-color: #2d3748;
        }
        .points-pulse {
            animation: pulse-effect 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-effect {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: .5;
                transform: scale(1.05);
            }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-start min-h-screen p-4">

    <!-- Main App Container -->
    <div id="main-app" class="w-full max-w-5xl dashboard-card p-8 mt-10 space-y-8">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center pb-6 border-b border-gray-700">
            <h1 class="text-3xl font-bold text-white mb-4 sm:mb-0">Social Spark</h1>
            <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4 text-sm font-semibold text-gray-400">
                <span id="user-id-display" class="text-xs">User ID: Guest</span>
                <div class="flex items-center space-x-2 p-2 rounded-lg gradient-bg text-white shadow-lg points-pulse">
                    <span>Points:</span>
                    <span id="earned-points-display" class="text-lg font-bold">0</span>
                    <span class="text-xs">(<span id="pending-points-display">0</span> Pending)</span>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
            <button id="nav-dashboard" class="nav-link active px-6 py-3 rounded-xl hover:bg-gray-600 transition-all">Dashboard</button>
            <button id="nav-tasks" class="nav-link px-6 py-3 rounded-xl hover:bg-gray-600 transition-all">Earn Points</button>
            <button id="nav-ads" class="nav-link px-6 py-3 rounded-xl hover:bg-gray-600 transition-all">Watch Ads</button>
            <button id="nav-create-campaign" class="nav-link px-6 py-3 rounded-xl hover:bg-gray-600 transition-all">Create Campaign</button>
            <button id="nav-my-campaigns" class="nav-link px-6 py-3 rounded-xl hover:bg-gray-600 transition-all">My Campaigns</button>
            <button id="nav-verification" class="nav-link px-6 py-3 rounded-xl hover:bg-gray-600 transition-all">Verify Tasks</button>
            <button id="nav-account" class="nav-link px-6 py-3 rounded-xl hover:bg-gray-600 transition-all">Account</button>
        </nav>

        <!-- Main Content Area -->
        <main class="mt-8">
            <!-- Dashboard View -->
            <div id="view-dashboard" class="page-view">
                <h2 class="text-2xl font-semibold mb-4 text-white">Your Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="dashboard-card p-6 flex flex-col items-center text-center">
                        <i class="fa-solid fa-star text-4xl text-yellow-400 mb-2"></i>
                        <span class="text-lg font-bold" id="dashboard-earned-points">0</span>
                        <p class="text-sm text-gray-400">Earned Points</p>
                    </div>
                    <div class="dashboard-card p-6 flex flex-col items-center text-center">
                        <i class="fa-solid fa-hourglass-half text-4xl text-blue-400 mb-2"></i>
                        <span class="text-lg font-bold" id="dashboard-pending-points">0</span>
                        <p class="text-sm text-gray-400">Pending Points</p>
                    </div>
                    <div class="dashboard-card p-6 flex flex-col items-center text-center">
                        <i class="fa-solid fa-rocket text-4xl text-purple-400 mb-2"></i>
                        <span class="text-lg font-bold" id="dashboard-active-campaigns">0</span>
                        <p class="text-sm text-gray-400">Active Campaigns</p>
                    </div>
                </div>
            </div>

            <!-- Tasks View -->
            <div id="view-tasks" class="page-view hidden">
                <h2 class="text-2xl font-semibold mb-4 text-white">Tasks to Earn Points</h2>
                <button id="simulate-task-btn" class="mb-4 px-6 py-2 gradient-bg text-white rounded-lg hover:opacity-80 transition-colors">Simulate Task from Another User</button>
                <div id="tasks-list" class="space-y-4 scrollbar-custom max-h-96 overflow-y-auto pr-2">
                    <!-- Task items will be dynamically added here -->
                    <p class="text-gray-400 text-center">Loading tasks...</p>
                </div>
            </div>
            
            <!-- Ads View -->
            <div id="view-ads" class="page-view hidden flex flex-col items-center text-center">
                <h2 class="text-2xl font-semibold mb-4 text-white">Watch Ads to Earn Points</h2>
                <div id="ads-container" class="w-full max-w-xl space-y-4">
                    <!-- Ad items will be dynamically added here -->
                </div>
            </div>

            <!-- Create Campaign View -->
            <div id="view-create-campaign" class="page-view hidden">
                <h2 class="text-2xl font-semibold mb-4 text-white">Create a New Campaign</h2>
                <form id="create-campaign-form" class="space-y-4">
                    <div>
                        <label for="platform" class="block text-gray-300">Campaign Type</label>
                        <select id="platform" class="w-full p-3 rounded-md dashboard-card text-white focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                            <option value="">Select a type</option>
                            <option value="youtube">YouTube</option>
                            <option value="facebook">Facebook</option>
                            <option value="tiktok">TikTok</option>
                            <option value="instagram">Instagram</option>
                            <option value="twitter">Twitter</option>
                            <option value="website-traffic">Website Traffic</option>
                        </select>
                    </div>
                    <div>
                        <label for="url" class="block text-gray-300">Profile/Page URL</label>
                        <input type="url" id="url" class="w-full p-3 rounded-md dashboard-card text-white focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g., https://youtube.com/channel/..." required>
                    </div>
                    <div>
                        <label for="points-per-task" class="block text-gray-300">Points per Task</label>
                        <input type="number" id="points-per-task" class="w-full p-3 rounded-md dashboard-card text-white focus:outline-none focus:ring-2 focus:ring-purple-500" min="1" max="1000" value="100" required>
                    </div>
                    <div>
                        <label for="total-budget" class="block text-gray-300">Total Budget (in points)</label>
                        <input type="number" id="total-budget" class="w-full p-3 rounded-md dashboard-card text-white focus:outline-none focus:ring-2 focus:ring-purple-500" min="100" required>
                    </div>
                    <div id="campaign-summary" class="dashboard-card p-4 text-sm text-gray-400">
                        <!-- Summary will be populated here -->
                    </div>
                    <button type="submit" class="w-full gradient-bg text-white font-bold py-3 rounded-xl transition-all hover:scale-105">Create Campaign</button>
                    <div id="create-campaign-message" class="text-center mt-4"></div>
                </form>
            </div>

            <!-- My Campaigns View -->
            <div id="view-my-campaigns" class="page-view hidden">
                <h2 class="text-2xl font-semibold mb-4 text-white">My Campaigns</h2>
                <div id="my-campaigns-list" class="space-y-4 scrollbar-custom max-h-96 overflow-y-auto pr-2">
                    <!-- My campaigns will be dynamically added here -->
                    <p class="text-gray-400 text-center">Loading your campaigns...</p>
                </div>
            </div>

            <!-- Verification View -->
            <div id="view-verification" class="page-view hidden">
                <h2 class="text-2xl font-semibold mb-4 text-white">Verify Task Completions</h2>
                <div id="verification-list" class="space-y-4 scrollbar-custom max-h-96 overflow-y-auto pr-2">
                    <!-- Tasks to verify will be dynamically added here -->
                    <p class="text-gray-400 text-center">No tasks to verify.</p>
                </div>
            </div>

            <!-- Account View -->
            <div id="view-account" class="page-view hidden">
                <h2 class="text-2xl font-semibold mb-4 text-white">Account Management</h2>
                <div id="profile-section" class="dashboard-card p-6 max-w-md mx-auto space-y-4">
                     <div class="flex flex-col sm:flex-row justify-between items-center pb-4 border-b border-gray-700">
                         <h3 class="text-xl font-semibold">Your Profile</h3>
                         <button id="logout-btn" class="px-4 py-2 mt-2 sm:mt-0 text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors">Logout</button>
                     </div>
                     <p class="text-gray-400">User ID: <span id="profile-id-display" class="font-bold text-white"></span></p>
                     
                     <!-- New Referral Section -->
                     <div id="referral-section" class="pt-4 border-t border-gray-700 space-y-2">
                         <h4 class="text-lg font-semibold">Your Referral Code</h4>
                         <p class="text-gray-400">Share this code with friends to earn bonus points!</p>
                         <div class="flex items-center space-x-2 bg-gray-700 p-3 rounded-lg">
                             <span id="referral-code-display" class="font-bold text-white text-lg"></span>
                             <button id="copy-code-btn" class="text-gray-400 hover:text-white transition-colors">
                                 <i class="fa-solid fa-clipboard"></i>
                             </button>
                         </div>
                         <p class="text-gray-400">Or use this link:</p>
                         <div class="flex items-center space-x-2 bg-gray-700 p-3 rounded-lg">
                             <span id="referral-link-display" class="font-bold text-white text-sm truncate"></span>
                             <button id="copy-link-btn" class="text-gray-400 hover:text-white transition-colors">
                                 <i class="fa-solid fa-clipboard"></i>
                             </button>
                         </div>
                     </div>
                </div>
            </div>

            <!-- Modal for messages (replaces alert() and prompt()) -->
            <div id="message-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border-2 border-purple-500 max-w-sm w-full text-center">
                    <p id="modal-text" class="text-white text-lg font-semibold mb-4"></p>
                    <input type="text" id="modal-input" class="w-full p-3 rounded-md dashboard-card text-white hidden" placeholder="Enter proof here...">
                    <button id="modal-close-btn" class="mt-4 px-6 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">OK</button>
                    <button id="modal-submit-btn" class="mt-4 px-6 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors hidden">Submit</button>
                </div>
            </div>
        </main>
    </div>

    <!-- The script for Firebase and app logic -->
    <script type="module">
        // Firebase global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, query, where, addDoc, updateDoc, getDocs, getDoc, increment, setDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        // Set Firebase log level to debug
        setLogLevel('debug');

        // Initialize Firebase services outside of any function to ensure they're always available
        const app = firebaseConfig ? initializeApp(firebaseConfig) : null;
        const auth = app ? getAuth(app) : null;
        const db = app ? getFirestore(app) : null;

        // UI Elements
        const mainApp = document.getElementById('main-app');
        const userIdDisplay = document.getElementById('user-id-display');
        const earnedPointsDisplay = document.getElementById('earned-points-display');
        const pendingPointsDisplay = document.getElementById('pending-points-display');
        const simulateTaskBtn = document.getElementById('simulate-task-btn');
        const logoutBtn = document.getElementById('logout-btn');

        // Views and Navigation
        const navButtons = document.querySelectorAll('.nav-link');
        const views = document.querySelectorAll('.page-view');
        const tasksList = document.getElementById('tasks-list');
        const myCampaignsList = document.getElementById('my-campaigns-list');
        const verificationList = document.getElementById('verification-list');
        const createCampaignForm = document.getElementById('create-campaign-form');
        const campaignSummary = document.getElementById('campaign-summary');
        const adsContainer = document.getElementById('ads-container');

        // Account View Elements
        const profileSection = document.getElementById('profile-section');
        const profileIdDisplay = document.getElementById('profile-id-display');

        // Referral System Elements
        const referralCodeDisplay = document.getElementById('referral-code-display');
        const referralLinkDisplay = document.getElementById('referral-link-display');
        const copyCodeBtn = document.getElementById('copy-code-btn');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        
        // Message Modal Elements
        const messageModal = document.getElementById('message-modal');
        const modalText = document.getElementById('modal-text');
        const modalInput = document.getElementById('modal-input');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalSubmitBtn = document.getElementById('modal-submit-btn');
        let modalCallback = null;

        // Hardcoded ad links
        const ads = [
            { url: "https://otieu.com/4/9677163", points: 1000 },
            { url: "https://otieu.com/4/9677167", points: 1000 }
        ];
        
        // Referral bonuses
        const REFERRER_BONUS = 500; // Increased to 500 points
        const NEW_USER_BONUS = 50;

        // Show a custom modal message
        function showMessage(message, inputNeeded = false, callback = null) {
            modalText.textContent = message;
            if (inputNeeded) {
                modalInput.classList.remove('hidden');
                modalSubmitBtn.classList.remove('hidden');
                modalCloseBtn.classList.add('hidden');
                modalCallback = callback;
                modalInput.focus();
            } else {
                modalInput.classList.add('hidden');
                modalSubmitBtn.classList.add('hidden');
                modalCloseBtn.classList.remove('hidden');
                modalCallback = null;
            }
            messageModal.classList.remove('hidden');
        }

        modalCloseBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });
        
        modalSubmitBtn.addEventListener('click', () => {
            const inputValue = modalInput.value;
            messageModal.classList.add('hidden');
            if (modalCallback) {
                modalCallback(inputValue);
            }
            modalInput.value = ''; // Reset input
        });

        // Function to switch between views
        function showView(viewId) {
            views.forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            navButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(`nav-${viewId.replace('view-', '')}`).classList.add('active');
        }

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const viewId = button.id.replace('nav-', 'view-');
                showView(viewId);
            });
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessage("Logged out successfully.");
            } catch (error) {
                console.error("Logout Error:", error);
                showMessage(`Logout failed: ${error.message}`);
            }
        });

        // Function to generate a random 6-8 character alphanumeric referral code
        function generateReferralCode() {
            const length = Math.floor(Math.random() * 3) + 6; // 6 to 8 characters
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Copy referral code to clipboard
        copyCodeBtn.addEventListener('click', () => {
            const code = referralCodeDisplay.textContent;
            navigator.clipboard.writeText(code).then(() => {
                showMessage('Referral code copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                showMessage('Failed to copy. Please try again.');
            });
        });

        // Copy referral link to clipboard
        copyLinkBtn.addEventListener('click', () => {
            const link = referralLinkDisplay.textContent;
            navigator.clipboard.writeText(link).then(() => {
                showMessage('Referral link copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                showMessage('Failed to copy. Please try again.');
            });
        });

        let userId = null;
        let unsubscribeListeners = [];

        // Initial setup on page load
        window.onload = async () => {
            if (!firebaseConfig) {
                console.error("Firebase config is missing or invalid. App cannot function.");
                return;
            }
            
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                showMessage("Failed to authenticate with Firebase. Please check the console.");
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `User ID: ${userId.substring(0, 8)}...`;
                    profileIdDisplay.textContent = userId;
                    profileSection.classList.remove('hidden');
                    
                    startRealtimeListeners();
                } else {
                    userId = null;
                    userIdDisplay.textContent = `User ID: Guest`;
                    profileSection.classList.add('hidden');
                    // Unsubscribe old listeners
                    unsubscribeListeners.forEach(unsubscribe => unsubscribe());
                    unsubscribeListeners = [];
                    // Clear the UI data for guests
                    earnedPointsDisplay.textContent = '0';
                    pendingPointsDisplay.textContent = '0';
                    document.getElementById('dashboard-earned-points').textContent = '0';
                    document.getElementById('dashboard-pending-points').textContent = '0';
                    document.getElementById('dashboard-active-campaigns').textContent = '0';
                    myCampaignsList.innerHTML = `<p class="text-gray-400 text-center py-4">You must be logged in to view your campaigns.</p>`;
                    verificationList.innerHTML = `<p class="text-gray-400 text-center py-4">You must be logged in to verify tasks.</p>`;
                }
                renderAds();
            });
        };

        // Start listening to Firestore collections once authenticated
        function startRealtimeListeners() {
            if (!db || !userId) {
                return;
            }

            // --- User Points and Referral Listener ---
            const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
            const unsubscribePoints = onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    const earned = data.pointsEarned || 0;
                    const pending = data.pointsPending || 0;
                    earnedPointsDisplay.textContent = earned.toLocaleString();
                    pendingPointsDisplay.textContent = pending.toLocaleString();
                    document.getElementById('dashboard-earned-points').textContent = earned.toLocaleString();
                    document.getElementById('dashboard-pending-points').textContent = pending.toLocaleString();
                    
                    // Update referral UI
                    const referralCode = data.referralCode || '';
                    if (referralCode) {
                        referralCodeDisplay.textContent = referralCode;
                        referralLinkDisplay.textContent = `${window.location.origin}${window.location.pathname}?ref=${referralCode}`;
                    }
                } else {
                    console.log("User document not found, creating a new one.");
                    setDoc(userDocRef, {
                        pointsEarned: 0,
                        pointsPending: 0,
                        referralCode: generateReferralCode(),
                        referredBy: null,
                        createdAt: new Date(),
                    }).catch(console.error);
                }
            });
            unsubscribeListeners.push(unsubscribePoints);


            // --- Tasks Listener ---
            const tasksQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), where('status', '==', 'available'));
            const unsubscribeTasks = onSnapshot(tasksQuery, async (snapshot) => {
                tasksList.innerHTML = '';
                if (snapshot.empty) {
                    tasksList.innerHTML = `<p class="text-gray-400 text-center py-4">No tasks available right now. Check back later!</p>`;
                } else {
                    snapshot.forEach(async (taskDoc) => {
                        const task = taskDoc.data();
                        const campaignDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'campaigns', task.campaignId);
                        const campaignSnap = await getDoc(campaignDocRef);
                        if (!campaignSnap.exists()) return;
                        const campaign = campaignSnap.data();
                        
                        // Check if the current user owns this campaign
                        if (campaign.ownerId === userId) {
                            return; // Do not show own tasks
                        }

                        const iconClass = getSocialIcon(campaign.socialMediaPlatform);
                        const buttonText = campaign.socialMediaPlatform === 'website-traffic' ? 'Go to Website' : 'Complete Task';
                        const taskItem = document.createElement('div');
                        taskItem.className = 'dashboard-card p-4 flex items-center justify-between';
                        taskItem.innerHTML = `
                            <div class="flex items-center space-x-4">
                                <i class="${iconClass} text-xl w-8 text-center"></i>
                                <div>
                                    <p class="font-bold text-white">Earn ${campaign.pointsPerTask} Points</p>
                                    <p class="text-sm text-gray-400">Complete task on ${campaign.socialMediaPlatform}</p>
                                    <p class="text-xs text-gray-500">Campaign ID: ${campaign.campaignId.substring(0, 8)}...</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <a href="${campaign.targetUrl}" target="_blank" class="px-4 py-2 text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition-colors">${buttonText}</a>
                                <button data-task-id="${taskDoc.id}" data-campaign-id="${campaign.campaignId}" class="complete-task-btn px-4 py-2 text-white gradient-bg rounded-lg hover:opacity-80 transition-colors">Submit Proof</button>
                            </div>
                        `;
                        tasksList.appendChild(taskItem);
                    });
                }
            });
            unsubscribeListeners.push(unsubscribeTasks);


            // --- My Campaigns Listener ---
            const myCampaignsQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'campaigns'), where('ownerId', '==', userId));
            const unsubscribeMyCampaigns = onSnapshot(myCampaignsQuery, async (snapshot) => {
                myCampaignsList.innerHTML = '';
                let activeCampaignsCount = 0;
                if (snapshot.empty) {
                    myCampaignsList.innerHTML = `<p class="text-gray-400 text-center py-4">You have not created any campaigns yet.</p>`;
                } else {
                    for (const campaignDoc of snapshot.docs) {
                        const campaign = campaignDoc.data();
                        const iconClass = getSocialIcon(campaign.socialMediaPlatform);
                        const tasksSnapshot = await getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), where('campaignId', '==', campaignDoc.id)));
                        const totalTasks = tasksSnapshot.size;
                        const completedTasks = tasksSnapshot.docs.filter(doc => doc.data().status === 'completed').length;
                        const pendingTasks = tasksSnapshot.docs.filter(doc => doc.data().status === 'pending_review').length;
                        
                        const campaignItem = document.createElement('div');
                        campaignItem.className = 'dashboard-card p-4 space-y-2';
                        campaignItem.innerHTML = `
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <i class="${iconClass} text-2xl w-8 text-center"></i>
                                    <div>
                                        <p class="font-bold text-white">${campaign.socialMediaPlatform.toUpperCase()} Campaign</p>
                                        <p class="text-sm text-gray-400 truncate w-40 sm:w-auto">${campaign.targetUrl}</p>
                                    </div>
                                </div>
                                <span class="px-3 py-1 text-xs font-semibold rounded-full gradient-bg">${completedTasks}/${totalTasks} tasks</span>
                            </div>
                            <div class="text-xs text-gray-500">
                                <span>Budget: ${campaign.totalPoints} points</span>
                                <span>|</span>
                                <span>Pending: ${pendingTasks} proofs</span>
                            </div>
                        `;
                        myCampaignsList.appendChild(campaignItem);
                        if (campaign.totalPoints > (completedTasks * campaign.pointsPerTask)) {
                             activeCampaignsCount++;
                        }
                    }
                }
                 document.getElementById('dashboard-active-campaigns').textContent = activeCampaignsCount.toLocaleString();
            });
            unsubscribeListeners.push(unsubscribeMyCampaigns);


            // --- Verification Listener (for tasks pending review) ---
            const proofsQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'proofs'), where('status', '==', 'pending'));
            const unsubscribeProofs = onSnapshot(proofsQuery, async (snapshot) => {
                verificationList.innerHTML = '';
                if (snapshot.empty) {
                    verificationList.innerHTML = `<p class="text-gray-400 text-center py-4">No tasks to verify.</p>`;
                    return;
                }

                for (const proofDoc of snapshot.docs) {
                    const proof = proofDoc.data();
                    const campaignDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'campaigns', proof.campaignId);
                    const campaignSnap = await getDoc(campaignDocRef);
                    if (!campaignSnap.exists()) continue;
                    const campaign = campaignSnap.data();
                    
                    if (campaign.ownerId === userId) { // Only show proofs for this user's campaigns
                        const proofItem = document.createElement('div');
                        proofItem.className = 'dashboard-card p-4 flex items-center justify-between';
                        proofItem.innerHTML = `
                            <div>
                                <p class="font-bold text-white">Proof from User: ${proof.submittedByUserId.substring(0, 8)}...</p>
                                <p class="text-sm text-gray-400">for campaign: ${campaign.socialMediaPlatform.toUpperCase()}</p>
                                <p class="text-xs text-gray-500">Submitted proof: ${proof.submittedProof}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button data-proof-id="${proofDoc.id}" class="approve-btn px-4 py-2 text-white bg-green-500 rounded-lg hover:bg-green-600 transition-colors">Approve</button>
                                <button data-proof-id="${proofDoc.id}" class="reject-btn px-4 py-2 text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors">Reject</button>
                            </div>
                        `;
                        verificationList.appendChild(proofItem);
                    }
                }
                if(verificationList.innerHTML.trim() === '') {
                     verificationList.innerHTML = `<p class="text-gray-400 text-center py-4">No tasks to verify.</p>`;
                }
            });
            unsubscribeListeners.push(unsubscribeProofs);
        }

        // Event listener for task completion buttons
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('complete-task-btn')) {
                if (!userId) {
                    showMessage("You must be logged in to complete a task and submit proof.");
                    return;
                }
                const taskId = e.target.dataset.taskId;
                const campaignId = e.target.dataset.campaignId;
                
                showMessage("Please provide your username as proof of completion:", true, async (proof) => {
                    if (!proof) {
                        showMessage("Proof submission cancelled.");
                        return;
                    }
                    try {
                        const proofCollection = collection(db, 'artifacts', appId, 'public', 'data', 'proofs');
                        await addDoc(proofCollection, {
                            taskId: taskId,
                            campaignId: campaignId,
                            submittedByUserId: userId,
                            submittedProof: proof,
                            status: 'pending'
                        });
                        
                        const taskDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'tasks', taskId);
                        await updateDoc(taskDocRef, {
                             assignedToUserId: userId,
                             status: 'pending_review'
                        });
                        
                        showMessage("Proof submitted successfully! Your points are pending verification.");
                    } catch (error) {
                        console.error("Error submitting proof:", error);
                        showMessage("Error submitting proof. Please try again.");
                    }
                });
            }

            if (e.target.classList.contains('approve-btn')) {
                const proofId = e.target.dataset.proofId;
                const proofDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'proofs', proofId);
                
                const proofSnap = await getDoc(proofDocRef);
                if (!proofSnap.exists()) return;
                const proofData = proofSnap.data();

                const campaignDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'campaigns', proofData.campaignId);
                const campaignSnap = await getDoc(campaignDocRef);
                if (!campaignSnap.exists()) return;
                const campaignData = campaignSnap.data();
                
                const userDocRef = doc(db, 'artifacts', appId, 'users', proofData.submittedByUserId);
                const userSnap = await getDoc(userDocRef);
                if(!userSnap.exists()) return;
                const userData = userSnap.data();
                
                await updateDoc(proofDocRef, { status: 'approved' });

                const taskDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'tasks', proofData.taskId);
                await updateDoc(taskDocRef, { status: 'completed' });

                await updateDoc(userDocRef, {
                    pointsEarned: increment(campaignData.pointsPerTask),
                });
                
                showMessage("Proof approved and points awarded!");
            }

            if (e.target.classList.contains('reject-btn')) {
                const proofId = e.target.dataset.proofId;
                const proofDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'proofs', proofId);
                await updateDoc(proofDocRef, { status: 'rejected' });
                showMessage("Proof rejected.");
            }
        });
        
        // Watch ad functionality
        function renderAds() {
            adsContainer.innerHTML = '';
            ads.forEach(ad => {
                const adItem = document.createElement('div');
                adItem.className = 'dashboard-card p-6 flex flex-col items-center space-y-4';
                adItem.innerHTML = `
                    <h3 class="text-xl font-bold text-white">Earn ${ad.points} Points</h3>
                    <p class="text-sm text-gray-400">Watch a quick ad to get rewarded instantly.</p>
                    <button data-url="${ad.url}" data-points="${ad.points}" class="watch-ad-btn w-full gradient-bg text-white font-bold py-3 rounded-xl transition-all hover:scale-105">Watch Ad</button>
                    <div class="ad-progress w-full h-2 bg-gray-600 rounded-full overflow-hidden hidden">
                        <div class="ad-bar h-full bg-green-500 transition-all duration-100 ease-linear" style="width: 0%;"></div>
                    </div>
                `;
                adsContainer.appendChild(adItem);
            });
        }
        
        adsContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('watch-ad-btn')) {
                if (!userId) {
                    showMessage("You must be logged in to watch an ad and earn points.");
                    return;
                }
                
                const url = e.target.dataset.url;
                const points = parseInt(e.target.dataset.points);
                const adButton = e.target;
                const adProgress = adButton.nextElementSibling;
                const adBar = adProgress.querySelector('.ad-bar');

                adButton.disabled = true;
                adButton.textContent = "Loading Ad...";
                adProgress.classList.remove('hidden');

                window.open(url, '_blank');
                
                let progress = 0;
                const adDuration = 5000; // 5 seconds
                const interval = 100;
                
                const progressInterval = setInterval(async () => {
                    progress += (interval / adDuration) * 100;
                    adBar.style.width = `${progress}%`;
                    if (progress >= 100) {
                        clearInterval(progressInterval);
                        adBar.style.width = '100%';
                        adButton.textContent = "Ad Completed!";
                        
                        try {
                            const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
                            const userSnap = await getDoc(userDocRef);
                            
                            if (!userSnap.exists()) {
                                await setDoc(userDocRef, {
                                    pointsEarned: points,
                                    pointsPending: 0
                                });
                            } else {
                                await updateDoc(userDocRef, {
                                    pointsEarned: increment(points)
                                });
                            }

                            showMessage(`You have earned ${points} points!`);
                        } catch (error) {
                            console.error("Error awarding points:", error);
                            showMessage("Error awarding points. Please try again.");
                        } finally {
                            adButton.disabled = false;
                            adProgress.classList.add('hidden');
                            adBar.style.width = '0%';
                            adButton.textContent = "Watch Ad";
                        }
                    }
                }, interval);
            }
        });

        // Event listener for campaign creation form
        createCampaignForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userId) {
                showMessage("You must be logged in to create a campaign.");
                return;
            }

            const platform = document.getElementById('platform').value;
            const url = document.getElementById('url').value;
            const pointsPerTask = parseInt(document.getElementById('points-per-task').value);
            const totalBudget = parseInt(document.getElementById('total-budget').value);

            if (totalBudget < pointsPerTask) {
                showMessage("Total budget must be greater than or equal to points per task.");
                return;
            }

            const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
            const userSnap = await getDoc(userDocRef);
            if(!userSnap.exists()) return;
            const userData = userSnap.data();

            if (userData.pointsEarned < totalBudget) {
                showMessage("You do not have enough earned points to create this campaign.");
                return;
            }
            
            try {
                // Deduct points from earned
                await updateDoc(userDocRef, {
                    pointsEarned: increment(-totalBudget),
                });
                
                const campaignRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'campaigns'), {
                    ownerId: userId,
                    socialMediaPlatform: platform,
                    targetUrl: url,
                    totalPoints: totalBudget,
                    pointsPerTask: pointsPerTask,
                    tasksCompleted: 0
                });
                
                // Create individual tasks
                const numTasks = Math.floor(totalBudget / pointsPerTask);
                for(let i = 0; i < numTasks; i++) {
                     await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), {
                        campaignId: campaignRef.id,
                        status: 'available',
                        assignedToUserId: null
                    });
                }
                
                showMessage("Campaign created successfully!");
                createCampaignForm.reset();
                showView('view-my-campaigns');
            } catch (error) {
                console.error("Error creating campaign:", error);
                showMessage("Failed to create campaign. Please try again.");
            }
        });
        
        // Dynamic summary for campaign creation
        document.getElementById('total-budget').addEventListener('input', updateCampaignSummary);
        document.getElementById('points-per-task').addEventListener('input', updateCampaignSummary);

        function updateCampaignSummary() {
            const pointsPerTask = parseInt(document.getElementById('points-per-task').value) || 0;
            const totalBudget = parseInt(document.getElementById('total-budget').value) || 0;
            
            if (pointsPerTask > 0 && totalBudget > 0) {
                const completions = Math.floor(totalBudget / pointsPerTask);
                campaignSummary.innerHTML = `
                    <p>This campaign will generate approximately <span class="font-bold text-white">${completions}</span> completions.</p>
                `;
            } else {
                campaignSummary.innerHTML = "Enter budget and points to see summary.";
            }
        }

        // Helper function for icons
        function getSocialIcon(platform) {
            switch (platform) {
                case 'youtube': return 'fab fa-youtube text-red-500';
                case 'facebook': return 'fab fa-facebook-f text-blue-500';
                case 'tiktok': return 'fab fa-tiktok text-white';
                case 'instagram': return 'fab fa-instagram text-pink-500';
                case 'twitter': return 'fab fa-twitter text-blue-400';
                case 'website-traffic': return 'fas fa-globe text-green-500';
                default: return 'fa-solid fa-link text-gray-400';
            }
        }
        
        // Simulates another user creating a campaign
        simulateTaskBtn.addEventListener('click', async () => {
             const simulatedUserId = `simulated_user_${Math.random().toString(36).substring(2, 15)}`;
             const simulatedPlatform = 'youtube';
             const simulatedUrl = `https://www.youtube.com/watch?v=mock_video_${Math.floor(Math.random() * 1000)}`;
             const simulatedPoints = 50;

             try {
                 const campaignRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'campaigns'), {
                     ownerId: simulatedUserId,
                     socialMediaPlatform: simulatedPlatform,
                     targetUrl: simulatedUrl,
                     totalPoints: 50,
                     pointsPerTask: simulatedPoints,
                     tasksCompleted: 0
                 });
                 
                 await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), {
                     campaignId: campaignRef.id,
                     status: 'available',
                     assignedToUserId: null
                 });
                 showMessage("A new task from another user has been simulated!");
             } catch (error) {
                 console.error("Error simulating task:", error);
                 showMessage("Failed to simulate task. Please check the console.");
             }
         });
    </script>
</body>
</html>
